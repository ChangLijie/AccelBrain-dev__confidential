name: Release AccelBrain

on:
  workflow_dispatch:

jobs:
  build-and-zip:
    strategy:
      matrix:
        version: ["22.04"]
    runs-on: ubuntu-${{ matrix.version }}

    steps:
      - name: Install dependencies
        run: |
        
          pip3 install pyinstaller

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract latest CHANGELOG entry and version
        id: changelog
        run: |
          CHANGELOG_CONTENT=$(awk 'BEGIN {print_section=0;} /^## \[/ {if (print_section == 0) {print_section=1;} else {exit;}} print_section {print;}' CHANGELOG.md)
          VERSION=$(echo "$CHANGELOG_CONTENT" | grep -oP '(?<=## \[)[^]]+')
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "version=v$VERSION" >> $GITHUB_OUTPUT

      - name: Build executables with PyInstaller
        run: |
          pyinstaller install.py --name Install --noconfirm --onefile --clean --distpath .

      - name: Prepare release zip
        run: |
          mkdir release
          cp Install launch.py port_setting.py shut_down.py run_compose.sh run.sh stop.sh docker-compose.yml CHANGELOG.md README.md release/
          cp -r setting release/
          cp -r tools release/
          zip -r release-ubuntu.zip release/

      - name: Upload artifact for ${{ matrix.version }}
        uses: actions/upload-artifact@v4
        with:
          name: release-ubuntu
          path: release-ubuntu.zip

  create-release:
    needs: build-and-zip
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract latest CHANGELOG entry and version
        id: changelog
        run: |
          CHANGELOG_CONTENT=$(awk 'BEGIN {print_section=0;} /^## \[/ {if (print_section == 0) {print_section=1;} else {exit;}} print_section {print;}' CHANGELOG.md)
          VERSION=$(echo "$CHANGELOG_CONTENT" | grep -oP '(?<=## \[)[^]]+')
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "version=v$VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.changelog.outputs.version }}
          name: ${{ steps.changelog.outputs.version }}
          body: ${{ steps.changelog.outputs.content }}
          files: |
            artifacts/release-ubuntu/release-ubuntu.zip
            
