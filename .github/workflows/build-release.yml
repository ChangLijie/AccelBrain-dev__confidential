name: Release AccelBrain

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk
          pip install pyinstaller

      - name: Extract latest CHANGELOG entry and version
        id: changelog
        run: |
          CHANGELOG_CONTENT=$(awk 'BEGIN {print_section=0;} /^## \[/ {if (print_section == 0) {print_section=1;} else {exit;}} print_section {print;}' CHANGELOG.md)
          VERSION=$(echo "$CHANGELOG_CONTENT" | grep -oP '(?<=## \[)[^]]+')
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "version=v$VERSION" >> $GITHUB_OUTPUT

      - name: Build executables with PyInstaller
        run: |
          pyinstaller launch.py --name AccelBrainLauncher --noconfirm --onefile --clean --distpath .
          pyinstaller port_setting.py --name Setting --noconfirm --onefile --clean --distpath .
          pyinstaller shut_down.py --name ShutDown --noconfirm --onefile --clean --distpath .

      - name: Prepare release zip
        run: |
          mkdir release
          cp AccelBrainLauncher.exe Setting.exe ShutDown.exe run_compose.sh run.sh stop.sh docker-compose.yml CHANGELOG.md README.md release/
          cp -r setting release/
          zip -r release.zip release/

      - name: Create GitHub release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.changelog.outputs.version }}
          name: ${{ steps.changelog.outputs.version }}
          body: ${{ steps.changelog.outputs.content }}
          files: release.zip
